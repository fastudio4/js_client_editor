<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/add.css">
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/fabric.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <title>Print to coffee</title>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-4">
            </div>
            <div class="col-md-4">
                <div>
                    <div class="form-group btn-group" role="group" id="image-editor">
                        <label class="btn btn-success btn-file"  id="add-image" data-toggle="tooltip" data-placement="top" title="Добавить">
                            <span class="glyphicon glyphicon-plus editor" aria-hidden="true"></span><input id="load-image" type="file" name="file">
                        </label>
                        <button type="button" id="delete-image" onclick="removeImage()" data-toggle="tooltip" data-placement="top" title="Удалить"><span class="glyphicon glyphicon-trash editor" aria-hidden="true"></span></button>
                        <button type="button" id="push-image" onclick="pushImage()" data-toggle="tooltip" data-placement="top" title="Увеличить"><span class="glyphicon glyphicon-zoom-in editor" aria-hidden="true"></span></button>
                        <button type="button" id="pull-image" onclick="pullImage()" data-toggle="tooltip" data-placement="top" title="Уменьшить"><span class="glyphicon glyphicon-zoom-out editor" aria-hidden="true"></span></button>
                        <button type="button" id="rotate-image" onclick="rotateImage()" data-toggle="tooltip" data-placement="top" title="Повернуть"><span class="glyphicon glyphicon-repeat editor" aria-hidden="true"></span></button>
                        <button type="button" id="mask-image" data-toggle="tooltip" data-placement="top" title="Фильтр"><span class="glyphicon glyphicon-tint editor" aria-hidden="true"></span> Фильтры</button>
                    </div>
                    <p id="error-loading-file" class="text-danger" role="alert"></p>
                </div>
                <canvas id="base-layout" style="border-radius: 50%; border:1px solid #6f4e37;"></canvas>
                <div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="Приблизить"><span class="glyphicon glyphicon-zoom-in editor" aria-hidden="true"></span></button>
                    </div>
                    <div class="form-group">
                            <textarea class="form-control" rows="2" id="text-input"></textarea>
                        </div>
                        <button id="add-text" class="btn btn-primary" type="button" onclick="addText()">Добавить</button>
                    </div>
            </div>

            <div class="col-md-4">
            </div>
        </div>
    </div>
    <script>
        var image;
        var scaleImage = 1.0;
        var canvas = new fabric.Canvas('base-layout', {
            preserveObjectStacking: true // disable bouncing layers on canvas
        });
            canvas.setHeight(400);
            canvas.setWidth(400);
            disabledEditor();
            document.getElementById('load-image').onchange = function handleImage(e) {
                var nameImage = document.getElementById('load-image').files[0].name;
                if (securityFormat(nameImage.toLowerCase()) == true) {
                    enableEditor();
                    document.getElementById('error-loading-file').innerHTML = '';
                    var reader = new FileReader();
                    reader.onload = function (event) {
                        var imgObj = new Image();
                        imgObj.src = event.target.result;
                        imgObj.onload = function () {
                            image = new fabric.Image(imgObj);
                            image.set({
                                hasRotatingPoint: false,
                                zIndex: 999
                            });
                            image.left = canvas.width / 2 - image.width / 2;
                            image.top = canvas.height / 2 - image.height / 2;
                            canvas.add(image);
                        };
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            };


        canvas.on('object:selected', function(options) {
            if (options.target.type == 'text') {
                console.log('Selected text')
            }
        });

        function disabledEditor() {
            var elements = document.getElementById("image-editor").getElementsByTagName('button');
            for(var i = 0; i < elements.length; i++) {
                elements[i].disabled = true;
                elements[i].className = "btn btn-default btn-lg"
            }
            document.getElementById('add-image').className = "btn btn-warning btn-lg btn-file";
            document.getElementById('load-image').disabled = false;
        }

        function enableEditor() {
            var elements = document.getElementById("image-editor").getElementsByTagName('button');
            for(var i = 0; i < elements.length; i++) {
                elements[i].disabled = false;
                elements[i].className = "btn btn-warning btn-lg"
            }
            document.getElementById('add-image').className = "btn btn-default btn-file btn-lg disabled";
            document.getElementById('load-image').disabled = true;
        }

        function removeImage() {
            canvas.remove(image);
            disabledEditor();
        }

        function pushImage() {
            if (scaleImage > 0 && scaleImage < 5) {
                scaleImage = scaleImage + 0.1;
                image.scale(scaleImage, scaleImage);
                canvas.centerObject(image);
                image.setCoords();
                canvas.renderAll();

            }
        }

        function pullImage() {
            if (scaleImage > 0.3 ) {
                scaleImage = scaleImage - 0.1;
                image.scale(scaleImage, scaleImage);
                canvas.centerObject(image);
                image.setCoords();
                canvas.renderAll();

            }
        }

        function securityFormat(name) {
            var acceptFormat = 'jpg jpeg png';
            var nameFile = name.split('/').pop();
            var formatFile = name.split('.').pop();
            if (nameFile != formatFile) {
                if (acceptFormat.indexOf(formatFile) >= 0) {
                    return true;
                }
                else {
                    document.getElementById('error-loading-file').innerHTML = 'Недопустимый формат файла!';
                    return false;
                }
            }
            else {
                document.getElementById('error-loading-file').innerHTML = 'Ошибка чтения файла!';
                return false;
            }
        }

        function addText() {
            var inputText = document.getElementById('text-input').value;
            if (document.getElementById('text-input').value != '') {
                document.getElementById('text-input').value = '';
                var text = new fabric.Text(inputText);
                text.left = canvas.width / 2 - text.width / 2;
                text.top = canvas.height / 2 - text.height / 2;
                canvas.add(text);
            }
        }

    </script>

</body>
</html>