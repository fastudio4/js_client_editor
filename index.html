<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/add.css">
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/fabric.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <title>Print to coffee</title>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-4">
            </div>
            <div class="col-md-4">
                <div>
                    <div class="form-group btn-group" role="group" id="image-editor">
                        <label class="btn btn-success btn-file" id="add-image" data-toggle="tooltip" data-placement="top" title="Добавить">
                            <span class="glyphicon glyphicon-plus editor" aria-hidden="true"></span><input id="load-image" type="file" name="file">
                        </label>
                        <button type="button" class="btn btn-default disabled" data-toggle="tooltip" data-placement="top" title="Удалить"><span class="glyphicon glyphicon-trash editor" aria-hidden="true"></span></button>
                        <button type="button" class="btn btn-default disabled" data-toggle="tooltip" data-placement="top" title="Увеличить"><span class="glyphicon glyphicon-zoom-in editor" aria-hidden="true"></span></button>
                        <button type="button" class="btn btn-default disabled" data-toggle="tooltip" data-placement="top" title="Уменьшить"><span class="glyphicon glyphicon-zoom-out editor" aria-hidden="true"></span></button>
                        <button type="button" class="btn btn-default disabled" data-toggle="tooltip" data-placement="top" title="Повернуть"><span class="glyphicon glyphicon-repeat editor" aria-hidden="true"></span></button>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-default dropdown-toggle disabled" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="glyphicon glyphicon-tint editor"></span> Фильтры
                                    <span class="caret"></span>
                            </button>
                                <ul class="dropdown-menu">
                                    <li><a href="#">Dropdown link</a></li>
                                    <li><a href="#">Dropdown link</a></li>
                                </ul>
                        </div>
                    </div>
                    <p id="error-loading-file" class="text-danger" role="alert"></p>
                </div>
                <canvas id="base-layout" style="border-radius: 50%; border:1px solid #6f4e37;"></canvas>
                <div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="Приблизить"><span class="glyphicon glyphicon-zoom-in editor" aria-hidden="true"></span></button>
                    </div>
                    <div class="form-group">
                            <textarea class="form-control" rows="2" id="text-input"></textarea>
                        </div>
                        <button id="add-text" class="btn btn-primary" type="button" onclick="addText()">Добавить</button>
                    </div>
            </div>

            <div class="col-md-4">
            </div>
        </div>
    </div>
    <script>
        var image;
        var canvas = new fabric.Canvas('base-layout', {
            preserveObjectStacking: true // disable bouncing layers on canvas
        });
            canvas.setHeight(400);
            canvas.setWidth(400);
            document.getElementById('load-image').onchange = function handleImage(e) {
                console.log();
                var nameImage = document.getElementById('load-image').files[0].name;
                if (securityFormat(nameImage.toLowerCase()) == true) {
                    document.getElementById('error-loading-file').innerHTML = '';
                    var reader = new FileReader();
                    reader.onload = function (event) {
                        var imgObj = new Image();
                        imgObj.src = event.target.result;
                        imgObj.onload = function () {
                            image = new fabric.Image(imgObj);
                            image.set({
                                hasRotatingPoint: false,
                                hasBorders: false,
                                zIndex: 999
                            });
                            canvas.add(image);
                        };
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            };


        canvas.on('object:selected', function(options) {
            if (options.target.type == 'image') {
                console.log(image);
                image.zIndex = 999;
                console.log('Selected')
            }
        });

        function securityFormat(name) {
            var acceptFormat = 'jpg jpeg png';
            var nameFile = name.split('/').pop();
            var formatFile = name.split('.').pop();
            if (nameFile != formatFile) {
                if (acceptFormat.indexOf(formatFile) >= 0) {
                    return true;
                }
                else {
                    document.getElementById('error-loading-file').innerHTML = 'Недопустимый формат файла!';
                    return false;
                }
            }
            else {
                document.getElementById('error-loading-file').innerHTML = 'Ошибка чтения файла!';
                return false;
            }
        }

        function removeImage(){
            canvas.remove(image);
            document.getElementById('add-image').style.display = '';
            document.getElementById('remote-image').style.display = 'none';
            document.getElementById('name-file').innerHTML = ''
        }

        function addText() {
            var inputText = document.getElementById('text-input').value;
            if (document.getElementById('text-input').value != '') {
                document.getElementById('text-input').value = '';
                var text = new fabric.Text(inputText);
                text.left = canvas.width / 2 - text.width / 2;
                text.top = canvas.height / 2 - text.height / 2;
                canvas.add(text);
            }
        }

    </script>

</body>
</html>